<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome — Shaiksab Perfumes | Spin & Win</title>
  <style>
    :root{
      --gold: #d4af37;
      --gold-dark: #b68f2a;
      --bg-dark: #0b0b0b;
      --accent: #ffcc80;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;}
    body{
      background: linear-gradient(180deg, #0b0b0b 0%, #0f0f0f 100%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .card{
      width:100%;
      max-width:420px;
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* Welcome page */
    .welcome{
      padding:36px 28px;
      text-align:center;
      background: linear-gradient(135deg, rgba(212,175,55,0.06), rgba(0,0,0,0.12));
    }
    h1.title{
      font-size:26px;
      margin:0 0 8px;
      letter-spacing:0.6px;
      color: var(--gold);
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
    }
    p.subtitle{
      margin:0 0 20px;
      color:#ddd;
      font-size:14px;
    }

    .input-row{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:12px;
    }
    input[type="tel"]{
      width:220px;
      padding:12px 14px;
      border-radius:10px;
      border:2px solid rgba(212,175,55,0.15);
      background:transparent;
      color:#fff;
      outline:none;
      font-size:16px;
    }
    button.primary{
      background: linear-gradient(180deg,var(--gold),var(--gold-dark));
      border:none;
      color:#0b0b0b;
      font-weight:700;
      padding:12px 18px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(182,143,42,0.18);
      transition: transform .12s ease;
    }
    button.primary:active{ transform: translateY(2px); }

    .error{
      color:#ff7b7b;
      margin-top:10px;
      font-size:13px;
    }

    /* Spin page */
    .spin-page{
      padding:20px;text-align:center;
    }
    canvas#wheel{
      display:block;
      margin: 8px auto 0;
      border-radius:50%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      background: linear-gradient(180deg, #fff, #fff);
    }
    .spin-btn{
      margin-top:14px;
      padding:10px 18px;
      border-radius:10px;
      border:none;
      background:var(--accent);
      color:#111;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }

    .result-wrap{
      margin-top:18px;
      min-height:80px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }

    .prize-text{
      font-size:18px;
      color:#fff;
      margin-bottom:8px;
    }

    .coupon{
      font-family: 'Segoe UI', Roboto, Arial;
      font-size:28px;
      padding:14px 18px;
      border-radius:12px;
      background: linear-gradient(90deg, rgba(212,175,55,0.12), rgba(212,175,55,0.06));
      color:var(--gold);
      font-weight:800;
      letter-spacing:1px;
      box-shadow: 0 8px 30px rgba(212,175,55,0.06);
      cursor:pointer;
      user-select: all;
      text-align:center;
    }

    .small-note{ font-size:12px;color:#cfcfcf;margin-top:8px; }

    /* popup */
    .popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
    }
    .popup .panel{
      background: #111;
      padding:18px;
      border-radius:12px;
      text-align:center;
      border: 1px solid rgba(255,255,255,0.03);
      width: 90%;
      max-width:360px;
    }
    .popup.show{ display:flex; }

    /* responsive */
    @media (max-width:420px){
      .card{ max-width:360px; }
      input[type="tel"]{ width:160px; }
    }
  </style>
</head>
<body>

  <div class="card" id="mainCard">

    <!-- PAGE 1: Welcome -->
    <div id="pageWelcome" class="welcome">
      <h1 class="title">Welcome to Shaiksab Perfumes</h1>
      <p class="subtitle">Enter your mobile number to spin & win exclusive discounts</p>

      <div class="input-row">
        <input type="tel" id="mobileInput" placeholder="10-digit mobile" maxlength="10" />
        <button class="primary" id="nextBtn">Next</button>
      </div>
      <div id="err" class="error" role="alert" aria-live="polite"></div>
      <div style="margin-top:14px;font-size:12px;color:#cfcfcf;">One spin per mobile number • Valid across devices</div>
    </div>

    <!-- PAGE 2: Spin -->
    <div id="pageSpin" class="spin-page" style="display:none;">
      <h2 style="margin:6px 0 10px;color:var(--gold);">Spin & Win — Shaiksab</h2>
      <canvas id="wheel" width="320" height="320"></canvas>
      <div>
        <button id="spinBtn" class="spin-btn">SPIN NOW</button>
      </div>

      <div class="result-wrap" id="resultWrap">
        <div class="prize-text" id="prizeText"></div>
        <div class="coupon" id="couponCode" title="Click to copy" style="display:none;"></div>
        <div class="small-note" id="copiedNote" style="display:none;color:var(--gold);">Copied to clipboard</div>
      </div>

      <div style="margin-top:12px;font-size:12px;color:#cfcfcf;">Share with friends — offers valid while stocks last</div>
    </div>

  </div>

  <!-- popup -->
  <div id="popup" class="popup"><div class="panel">
    <div id="popupText" style="font-size:16px;color:#fff;margin-bottom:10px;"></div>
    <button class="primary" id="popupClose">OK</button>
  </div></div>

  <!-- confetti small lib (simple) -->
  <script>
    // tiny confetti function (no external lib)
    function confettiBurst(){
      const count = 30;
      for(let i=0;i<count;i++){
        const el = document.createElement('div');
        el.style.position='fixed';
        el.style.zIndex=9998;
        el.style.left = (50 + (Math.random()*80-40)) + '%';
        el.style.top = (30 + Math.random()*20) + '%';
        el.style.width = (6 + Math.random()*8) + 'px';
        el.style.height = (10 + Math.random()*12) + 'px';
        el.style.background = ['#FFD700','#FFB86B','#FF6B6B','#8AFFC1','#CBA6FF'][Math.floor(Math.random()*5)];
        el.style.transform = 'rotate('+ (Math.random()*360) +'deg)';
        el.style.opacity = '0.95';
        el.style.borderRadius = '2px';
        el.style.transition = 'transform 1.2s ease-out, top 1.2s ease-out, opacity 1.2s';
        document.body.appendChild(el);
        requestAnimationFrame(()=>{
          el.style.top = (80 + Math.random()*10) + '%';
          el.style.transform = 'translateY(300px) rotate('+ (Math.random()*720) +'deg)';
          el.style.opacity = '0';
        });
        setTimeout(()=> el.remove(),1400 + Math.random()*600);
      }
    }
  </script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ----- Your Firebase config (replace with your own) -----
    const firebaseConfig = {
      apiKey: "AIzaSyBV5mCurQIrM61OGoWYi5rJMOe--N51wIw",
      authDomain: "spin-offer-80194.firebaseapp.com",
      projectId: "spin-offer-80194",
      storageBucket: "spin-offer-80194.firebasestorage.app",
      messagingSenderId: "289979000026",
      appId: "1:289979000026:web:95f862b209d35cf15831e3",
      measurementId: "G-G9B7MLWZSM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // offers (in same order around wheel)
    const OFFERS = ["5% OFF","10% OFF","15% OFF","20% OFF","25% OFF","35% OFF","40% OFF"];

    // UI refs
    const pageWelcome = document.getElementById('pageWelcome');
    const pageSpin = document.getElementById('pageSpin');
    const mobileInput = document.getElementById('mobileInput');
    const nextBtn = document.getElementById('nextBtn');
    const err = document.getElementById('err');
    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popupText');
    const popupClose = document.getElementById('popupClose');

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const prizeText = document.getElementById('prizeText');
    const couponCode = document.getElementById('couponCode');
    const copiedNote = document.getElementById('copiedNote');

    let mobile = '';
    let isSpinning = false;
    let startAngle = 0;
    let angularVelocity = 0;
    const radius = canvas.width/2;

    // draw wheel function
    function drawWheel(angleOffset=0){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const n = OFFERS.length;
      const arc = 2*Math.PI / n;
      for(let i=0;i<n;i++){
        const start = i*arc + angleOffset;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius-4, start, start+arc, false);
        ctx.closePath();
        ctx.fillStyle = (i%2===0) ? '#FFDAB3' : '#FFECCF';
        ctx.fill();

        // Text
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(start + arc/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#111";
        ctx.font = "bold 16px Arial";
        ctx.fillText(OFFERS[i], radius - 22, 6);
        ctx.restore();
      }

      // center disc
      ctx.beginPath();
      ctx.arc(radius, radius, 60, 0, 2*Math.PI);
      ctx.fillStyle = '#111';
      ctx.fill();

      // pointer (top)
      ctx.fillStyle = '#d4af37';
      ctx.beginPath();
      ctx.moveTo(radius-12, 8);
      ctx.lineTo(radius+12, 8);
      ctx.lineTo(radius, 36);
      ctx.closePath();
      ctx.fill();
    }
    drawWheel();

    // show popup
    function showPopup(message){
      popupText.innerText = message;
      popup.classList.add('show');
    }
    popupClose.addEventListener('click', ()=> popup.classList.remove('show'));

    nextBtn.addEventListener('click', async () => {
      err.innerText = '';
      const val = mobileInput.value.trim();
      if(!/^\d{10}$/.test(val)){
        err.innerText = 'Please enter a valid 10-digit mobile number.';
        return;
      }
      mobile = val;
      // check Firestore
      try{
        const docRef = doc(db, 'spins', mobile);
        const snap = await getDoc(docRef);
        if(snap.exists()){
          showPopup("You have already spun the wheel with this number.");
          return;
        } else {
          // go to spin page
          pageWelcome.style.display = 'none';
          pageSpin.style.display = 'block';
          // reset UI
          prizeText.innerText = '';
          couponCode.style.display = 'none';
          copiedNote.style.display = 'none';
          drawWheel();
        }
      } catch(e){
        console.error(e);
        err.innerText = 'Network error — try again.';
      }
    });

    // spin mechanics: simple deceleration
    spinBtn.addEventListener('click', () => {
      if(isSpinning) return;
      isSpinning = true;
      prizeText.innerText = '';
      couponCode.style.display = 'none';
      copiedNote.style.display = 'none';

      // randomize final index by giving random velocity
      const randomVel = (Math.random() * 18) + 18; // initial velocity
      angularVelocity = randomVel;
      animateSpin();
    });

    function animateSpin(){
      // simple physics: angularVelocity decreases
      const friction = 0.985; // slowdown
      const minVel = 0.002;
      const frame = () => {
        angularVelocity *= friction;
        startAngle += angularVelocity * 0.04; // step
        drawWheel(startAngle);
        if(angularVelocity > minVel){
          requestAnimationFrame(frame);
        } else {
          // stop, determine prize
          isSpinning = false;
          // normalize angle to [0, 2PI)
          const normalized = (startAngle % (2*Math.PI) + 2*Math.PI) % (2*Math.PI);
          // pointer at top (angle - PI/2)
          const angleFromTop = (2*Math.PI - normalized + Math.PI/2) % (2*Math.PI);
          const segment = Math.floor(angleFromTop / (2*Math.PI / OFFERS.length)) % OFFERS.length;
          const won = OFFERS[segment];
          // coupon code formatting: SHAIKSAB{number}OFF
          const numOnly = won.replace('% OFF','').replace(/\s/g,'');
          const code = `SHAIKSAB${numOnly}OFF`;

          // show result
          prizeText.innerText = `You won: ${won}`;
          couponCode.innerText = code;
          couponCode.style.display = 'block';
          couponCode.style.fontSize = '30px';
          couponCode.style.marginTop = '12px';

          // store in Firestore
          (async ()=>{
            try{
              await setDoc(doc(db, 'spins', mobile), {
                mobile: mobile,
                offer: won,
                code: code,
                createdAt: serverTimestamp()
              });
            }catch(e){
              console.error('save error', e);
            }
          })();

          // confetti
          confettiBurst();

          // small animation to draw attention
          couponCode.animate([
            { transform: 'scale(0.85)', opacity: 0 },
            { transform: 'scale(1.05)', opacity: 1 },
            { transform: 'scale(1)', opacity: 1 }
          ], { duration: 700, easing: 'cubic-bezier(.2,.9,.2,1)' });
        }
      };
      requestAnimationFrame(frame);
    }

    // copy on click
    couponCode.addEventListener('click', async () => {
      const text = couponCode.innerText;
      try{
        await navigator.clipboard.writeText(text);
        copiedNote.style.display = 'block';
        setTimeout(()=> copiedNote.style.display = 'none', 2200);
      }catch(e){
        // fallback: select text
        const range = document.createRange();
        range.selectNode(couponCode);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try{ document.execCommand('copy'); copiedNote.style.display='block'; setTimeout(()=>copiedNote.style.display='none',2200);}catch(err){}
        window.getSelection().removeAllRanges();
      }
    });

    // optional: allow Enter key on mobile input
    mobileInput.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ nextBtn.click(); } });

  </script>
</body>
</html>